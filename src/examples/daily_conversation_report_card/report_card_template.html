<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Daily Conversation Report Card</title>
  <style>
    body { font-family: Arial, Helvetica, sans-serif; margin: 24px; color: #111; }
    h1 { font-size: 22px; margin: 0 0 6px 0; }
    h2 { font-size: 16px; margin: 20px 0 10px 0; }
    .meta { margin-bottom: 16px; color: #444; }
    .cards { display: flex; gap: 12px; flex-wrap: wrap; }
    .card { border: 1px solid #ddd; border-radius: 10px; padding: 12px; min-width: 190px; }
    .label { font-size: 12px; color: #555; }
    .value { font-size: 20px; font-weight: 700; margin-top: 2px; }
    .sub { font-size: 12px; color: #666; margin-top: 4px; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border-bottom: 1px solid #eee; padding: 8px 6px; text-align: left; font-size: 13px; }
    th { background: #fafafa; font-weight: 700; }
    code { background: #f6f6f6; padding: 2px 4px; border-radius: 4px; }
    .muted { color: #777; }
  </style>
</head>
<body>
  <h1>Daily Conversation Report Card</h1>
  <div class="meta">
    Run date: <b>{{#def.vars.date}}</b><br/>
    Company: <b>{{#def.vars.company}}</b><br/>
    Interval: <code>{{#def.vars.previousInterval}}</code> (timezone: <code>{{#def.vars.timezone}}</code>)<br/>
    Job: <b>{{#def.job.name}}</b> · Configuration: <b>{{#def.configuration.name}}</b>
  </div>

  {{ var t = it.data.report && it.data.report.totals ? it.data.report.totals : null; }}

  <div class="cards">
    <div class="card">
      <div class="label">Offered</div>
      <div class="value">{{=t ? t.offered : '—'}}</div>
      <div class="sub">All voice ACD queue interactions</div>
    </div>
    <div class="card">
      <div class="label">Answered</div>
      <div class="value">{{=t ? t.answered : '—'}}</div>
      <div class="sub">{{=t ? ('ASA: ' + t.asaSeconds + 's') : ''}}</div>
    </div>
    <div class="card">
      <div class="label">Abandoned</div>
      <div class="value">{{=t ? t.abandoned : '—'}}</div>
      <div class="sub">{{=t ? ('Abandon rate: ' + t.abandonRatePercent + '%') : ''}}</div>
    </div>
    <div class="card">
      <div class="label">Service level</div>
      <div class="value">{{=t ? (t.serviceLevelPercent + '%') : '—'}}</div>
      <div class="sub">Over SLA: {{=t ? t.overSla : '—'}} · AHT: {{=t ? (t.ahtSeconds + 's') : '—'}}</div>
    </div>
  </div>

  <h2>Worst service level queues (top 10)</h2>
  <table>
    <thead>
      <tr>
        <th>Queue</th>
        <th>Offered</th>
        <th>Answered</th>
        <th>Abandoned</th>
        <th>Service level</th>
        <th>ASA (s)</th>
        <th>AHT (s)</th>
      </tr>
    </thead>
    <tbody>
      {{ var wq = (it.data.report && it.data.report.worstQueues) ? it.data.report.worstQueues : []; }}
      {{~wq :r}}
      <tr>
        <td>{{=r.queue && r.queue.name ? r.queue.name : r.queueId}}</td>
        <td>{{=r.offered}}</td>
        <td>{{=r.answered}}</td>
        <td>{{=r.abandoned}}</td>
        <td>{{=r.serviceLevelPercent}}%</td>
        <td>{{=r.asaSeconds}}</td>
        <td>{{=r.ahtSeconds}}</td>
      </tr>
      {{~}}
      {{? wq.length === 0 }}
      <tr><td colspan="7" class="muted">No queue aggregate results returned for this interval.</td></tr>
      {{?}}
    </tbody>
  </table>

  <h2>Recent abandons (sample of up to 25)</h2>
  <table>
    <thead>
      <tr>
        <th>Time</th>
        <th>Queue</th>
        <th>ANI</th>
        <th>DNIS</th>
        <th>Conversation ID</th>
      </tr>
    </thead>
    <tbody>
      {{ var ra = (it.data.report && it.data.report.recentAbandons) ? it.data.report.recentAbandons : []; }}
      {{~ra :a}}
      <tr>
        <td>{{=a.conversationStart || ''}}</td>
        <td>{{=a.queueName || ''}}</td>
        <td>{{=a.ani || ''}}</td>
        <td>{{=a.dnis || ''}}</td>
        <td><code>{{=a.conversationId}}</code></td>
      </tr>
      {{~}}
      {{? ra.length === 0 }}
      <tr><td colspan="5" class="muted">No abandons returned in the sample query.</td></tr>
      {{?}}
    </tbody>
  </table>

  <p class="muted" style="margin-top:16px;">
    Notes: This report uses <code>/api/v2/analytics/conversations/aggregates/query</code> metrics such as <code>nOffered</code>, <code>tAnswered</code>, <code>tAbandon</code>, and <code>oServiceLevel</code>.
  </p>
</body>
</html>
